<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - AFLA-DRY 360Â°</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" />
</head>
<body>
    <!-- HEADER -->
    <header>
        <a href="index.html" class="logo"><i class="ri-home-heart-line"></i> AFLA-DRY 360Â°</a>
        <div id="menu-icon">
            <i class="ri-menu-line"></i>
        </div>
        <ul class="navbar">
            <li><a href="index.html#home">Home</a></li>
            <li><a href="index.html#about">About</a></li>
            <li><a href="index.html#services">Services</a></li>
            <li><a href="index.html#how-it-works">How it works</a></li>
            <li><a href="index.html#contact">Contact</a></li>
        </ul>
        <div class="background">
            <img src="cover-bg.jpg" alt="Logo Icon" />
        </div>
    </header>

    <!-- LOGIN SECTION -->
    <div class="login-container">
        <div class="login-content">
          
            <div class="form">
                <h2>Login Here</h2>
                <form id="login-form">
                    <label for="email">Email:</label><br>
                    <input type="email" id="email" name="email" placeholder="Enter email here" required><br><br>

                    <label for="password">Password:</label><br>
                    <input type="password" id="password" name="password" placeholder="Enter password here" required><br><br>

                    <button type="submit" class="sign">Login</button>
                </form>

                <p>Don't have an account?</p>
                <a href="#" class="signup-btn" onclick="showSignupForm()">Sign Up</a>
                
                <p>Or sign up with social accounts:</p>
                <div class="social-icons">
                    <a href="#" class="circle-icon facebook" onclick="handleSocialSignup('facebook')"><i class="ri-facebook-fill"></i></a>
                    <a href="#" class="circle-icon google" onclick="handleSocialSignup('google')"><i class="ri-google-fill"></i></a>
                    <a href="#" class="circle-icon instagram" onclick="handleSocialSignup('instagram')"><i class="ri-instagram-line"></i></a>
                    <a href="#" class="circle-icon twitter" onclick="handleSocialSignup('twitter')"><i class="ri-twitter-fill"></i></a>
                </div>
            </div>
            
            <div class="farmer-first">
                <img src="farmer about.webp" alt="Picture of a farmer">
            </div>
        </div>
    </div>

    <!-- SIGNUP MODAL -->
    <div class="modal" id="signup-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Account</h3>
                <span class="close" onclick="closeSignupModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="signup-form">
                    <div class="form-group">
                        <label for="signup-username">Username:</label>
                        <input type="text" id="signup-username" name="username" placeholder="Enter username" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-email">Email:</label>
                        <input type="email" id="signup-email" name="email" placeholder="Enter email" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-fullname">Full Name:</label>
                        <input type="text" id="signup-fullname" name="full_name" placeholder="Enter full name" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password:</label>
                        <input type="password" id="signup-password" name="password" placeholder="Enter password" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-confirm-password">Confirm Password:</label>
                        <input type="password" id="signup-confirm-password" name="confirm_password" placeholder="Confirm password" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeSignupModal()">Cancel</button>
                        <button type="submit" class="btn-primary">Create Account</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Status Display -->
    <div id="status-display" style="position: fixed; top: 20px; right: 20px; padding: 15px; background: #f0f0f0; border-radius: 5px; display: none;"></div>

    <script>
        // Global variables
        let isBackendRunning = false;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            initializePage();
        });

        function initializePage() {
            // Setup mobile menu
            const menuIcon = document.getElementById('menu-icon');
            const navbar = document.querySelector('.navbar');
            
            if (menuIcon && navbar) {
                menuIcon.addEventListener('click', () => {
                    navbar.classList.toggle('active');
                });
            }

            // Setup form event listeners
            setupFormListeners();
            
            // Test backend connection
            testBackendConnection();
        }

        function setupFormListeners() {
            // Login form
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
                console.log('Login form listener attached');
            } else {
                console.error('Login form not found!');
            }

            // Signup form
            const signupForm = document.getElementById('signup-form');
            if (signupForm) {
                signupForm.addEventListener('submit', handleSignup);
                console.log('Signup form listener attached');
            } else {
                console.error('Signup form not found!');
            }
        }

        async function testBackendConnection() {
            try {
                console.log('Testing backend connection...');
                const response = await fetch('http://localhost:5000/api/health');
                if (response.ok) {
                    isBackendRunning = true;
                    showStatus('âœ… Backend connected', 'success');
                    console.log('Backend is running');
                } else {
                    isBackendRunning = false;
                    showStatus('âŒ Backend error: ' + response.status, 'error');
                    console.log('Backend error:', response.status);
                }
            } catch (error) {
                isBackendRunning = false;
                showStatus('âŒ Backend not accessible: ' + error.message, 'error');
                console.error('Backend connection failed:', error);
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            console.log('Login form submitted');
            
            if (!isBackendRunning) {
                alert('Backend server is not running. Please start the server first.');
                return;
            }
            
            const formData = new FormData(e.target);
            const loginData = {
                email: formData.get('email'),
                password: formData.get('password')
            };

            try {
                console.log('Attempting login with:', loginData);
                showStatus('ðŸ”„ Logging in...', 'info');
                
                const response = await fetch('http://localhost:5000/api/auth/signin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });

                console.log('Login response:', response);

                if (response.ok) {
                    const data = await response.json();
                    console.log('Login successful:', data);
                    showStatus('âœ… Login successful!', 'success');
                    
                    localStorage.setItem('authToken', data.data.token);
                    localStorage.setItem('userData', JSON.stringify(data.data.user));
                    
                    // Redirect to dashboard
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1000);
                } else {
                    const errorData = await response.json();
                    console.error('Login failed:', errorData);
                    showStatus('âŒ Login failed: ' + errorData.message, 'error');
                    alert('Login failed: ' + errorData.message);
                }
            } catch (error) {
                console.error('Login error:', error);
                showStatus('âŒ Login error: ' + error.message, 'error');
                alert('Login failed: ' + error.message);
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            console.log('Signup form submitted');
            
            if (!isBackendRunning) {
                alert('Backend server is not running. Please start the server first.');
                return;
            }
            
            const formData = new FormData(e.target);
            const password = formData.get('password');
            const confirmPassword = formData.get('confirm_password');
            
            if (password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            const signupData = {
                username: formData.get('username'),
                email: formData.get('email'),
                full_name: formData.get('full_name'),
                password: password
            };

            try {
                console.log('Attempting signup with:', signupData);
                console.log('Data types:', {
                    username: typeof signupData.username + ' (' + signupData.username + ')',
                    email: typeof signupData.email + ' (' + signupData.email + ')',
                    full_name: typeof signupData.full_name + ' (' + signupData.full_name + ')',
                    password: typeof signupData.password + ' (length: ' + signupData.password.length + ')'
                });
                showStatus('ðŸ”„ Creating account...', 'info');
                
                const response = await fetch('http://localhost:5000/api/auth/signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(signupData)
                });

                console.log('Signup response:', response);

                if (response.ok) {
                    const data = await response.json();
                    console.log('Signup successful:', data);
                    showStatus('âœ… Account created successfully!', 'success');
                    
                    alert('Account created successfully! Please login with your credentials.');
                    closeSignupModal();
                    document.getElementById('signup-form').reset();
                } else {
                    const errorData = await response.json();
                    console.error('Signup failed:', errorData);
                    
                    // Show detailed validation errors
                    if (errorData.errors && errorData.errors.length > 0) {
                        const errorMessages = errorData.errors.map(err => `${err.param}: ${err.msg}`).join('\n');
                        showStatus('âŒ Validation errors', 'error');
                        alert('Signup failed due to validation errors:\n\n' + errorMessages);
                    } else {
                        showStatus('âŒ Signup failed: ' + errorData.message, 'error');
                        alert('Signup failed: ' + errorData.message);
                    }
                }
            } catch (error) {
                console.error('Signup error:', error);
                showStatus('âŒ Signup error: ' + error.message, 'error');
                alert('Signup failed: ' + error.message);
            }
        }

        // Modal functions
        function showSignupForm() {
            console.log('Opening signup modal');
            const modal = document.getElementById('signup-modal');
            if (modal) {
                modal.style.display = 'block';
            }
        }

        function closeSignupModal() {
            console.log('Closing signup modal');
            const modal = document.getElementById('signup-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Social signup functions
        function handleSocialSignup(provider) {
            console.log('Social signup clicked:', provider);
            alert(`${provider.charAt(0).toUpperCase() + provider.slice(1)} signup integration coming soon! For now, please use the regular signup form.`);
        }

        // Utility functions
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-display');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.style.display = 'block';
                statusDiv.style.background = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1';
                statusDiv.style.color = type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460';
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // Debug info
        console.log('Login page JavaScript loaded successfully');
        console.log('Available functions:', {
            showSignupForm,
            closeSignupModal,
            handleSocialSignup,
            testBackendConnection
        });
    </script>
</body>
</html>